<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log - Nguyen Thi Yen Nhi</title>
    <link rel="stylesheet" type="text/css" href="../css/mainstyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    </style>
</head>
<body>
    <!-- MENU  -->
    <div id="menu">
        <ul class="mainmenu">
            <li><a href="about.html"><i class="fas fa-home"></i> About me</a></li>
            <li>
                <a href="#"><i class="fas fa-code"></i> Form & JavaScript</a>
                <ul class="submenu js">
                    <li><a href="product.html"><i class="fas fa-box"></i> Products</a></li>
                    <li><a href="emp.html"><i class="fas fa-users"></i> Employees</a></li>
                </ul>
            </li>
            <li>
                <a href="#"><i class="fas fa-cloud"></i> API and External</a>
                <ul class="submenu api">
                    <li><a href="weather.html"><i class="fas fa-cloud-sun"></i> Weather API</a></li>
                    <li><a href="rss.html"><i class="fas fa-rss"></i> RSS</a></li>
                </ul>
            </li>
            <li><a href="log.html" id="loginMenuLink"><i class="fas fa-sign-in-alt"></i> Login/Logout</a></li>
        </ul>
    </div>

    <!-- LEFT SIDE - B√™n tr√°i -->
    <div class="left-side">
        <div class="left-content">
            <h3><i class="fas fa-dice"></i> Vietlott Jackpot</h3>
            <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Part B: Q8 - AJAX Implementation</p>
            
            <div class="radio-container-left">
                <div class="radio-option-left">
                    <input type="radio" id="mega645" name="lottery" value="mega645" checked>
                    <label for="mega645"><i class="fas fa-trophy"></i> mega645</label>
                </div>
                <div class="radio-option-left">
                    <input type="radio" id="power655" name="lottery" value="power655">
                    <label for="power655"><i class="fas fa-star"></i> power655</label>
                </div>
            </div>
            
            <div class="loading-left" id="loading">
                <p><i class="fas fa-spinner fa-spin"></i> Loading...</p>
            </div>
            
            <div class="error-left" id="error"></div>
            
            <div class="results-left" id="results"></div>
        </div>
    </div>

    <!-- RIGHT SIDE - B√™n ph·∫£i -->
    <div class="side">
        <marquee direction="down" behavior="scroll" loop="-1" scrollamount="10"> 
            <p class="right">
                <i class="fas fa-certificate"></i><br>
                I declare that all of these solutions are my own and not copied from anyone in this class.
            </p>
        </marquee>
    </div>

    <!-- CONTAINER - Gi·ªØa -->
    <div class="container">
        <main class="content">
            <div class="login-container">
                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="loading-overlay">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>ƒêang t·∫£i d·ªØ li·ªáu t√†i kho·∫£n...</p>
                </div>

                <!-- Login Form -->
                <div id="loginForm">
                    <h2>
                        <i class="fas fa-sign-in-alt"></i>
                        ƒêƒÉng Nh·∫≠p
                    </h2>

                    <div id="errorMessage" class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="errorText"></span>
                    </div>

                    <div id="successMessage" class="success-message">
                        <i class="fas fa-check-circle"></i>
                        <span id="successText"></span>
                    </div>

                    <form onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label for="username">
                                <i class="fas fa-user"></i> T√™n ƒëƒÉng nh·∫≠p
                            </label>
                            <input 
                                type="text" 
                                id="username" 
                                name="username" 
                                placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label for="password">
                                <i class="fas fa-lock"></i> M·∫≠t kh·∫©u
                            </label>
                            <input 
                                type="password" 
                                id="password" 
                                name="password" 
                                placeholder="Nh·∫≠p m·∫≠t kh·∫©u"
                                required
                            >
                        </div>

                        <button type="submit" class="btn-login">
                            <i class="fas fa-sign-in-alt"></i> ƒêƒÉng Nh·∫≠p
                        </button>
                    </form>

                    <div class="info-box">
                        <p>
                            <strong><i class="fas fa-info-circle"></i> L∆∞u √Ω:</strong>
                            D·ªØ li·ªáu t√†i kho·∫£n ƒë∆∞·ª£c load t·ª´ file JSON. 
                            H·ªá th·ªëng s·ª≠ d·ª•ng localStorage ƒë·ªÉ l∆∞u tr·∫°ng th√°i ƒëƒÉng nh·∫≠p.
                        </p>
                    </div>
                </div>

                <!-- Logout Section -->
                <div id="logoutSection">
                    <h2>
                        <i class="fas fa-user-check"></i>
                        Th√¥ng Tin T√†i Kho·∫£n
                    </h2>

                    <div class="user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <h3>Xin ch√†o!</h3>
                        <p><strong>H·ªç t√™n:</strong> <span id="displayFullName"></span></p>
                        <p><strong>T√™n ƒëƒÉng nh·∫≠p:</strong> <span id="displayUsername"></span></p>
                        <p><strong>Vai tr√≤:</strong> <span id="displayRole"></span></p>
                        <p><strong>Th·ªùi gian ƒëƒÉng nh·∫≠p:</strong> <span id="loginTime"></span></p>
                        <p><strong>Tr·∫°ng th√°i:</strong> <span style="color: #28a745;">‚úì ƒê√£ ƒëƒÉng nh·∫≠p</span></p>
                    </div>

                    <button onclick="handleLogout()" class="btn-login btn-logout">
                        <i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t
                    </button>

                </div>
            </div>
        </main>
    </div>

    <!-- FOOTER - D∆∞·ªõi c√πng -->
    <div class="footer-info">
        <p>
            <i class="fas fa-user-graduate"></i> 
            <strong>ƒê√¢y l√† b√†i l√†m c·ªßa Nguy·ªÖn Th·ªã Y·∫øn Nhi</strong>, th·ª±c hi·ªán ng√†y 
            <strong><i class="fas fa-calendar-alt"></i> <span id="currentDate"></span></strong>
        </p>
    </div>

    <script src="../js/main.js"></script>
    <script>
        // Hi·ªÉn th·ªã ng√†y hi·ªán t·∫°i
        document.getElementById("currentDate").textContent = new Date().toLocaleDateString('vi-VN');

        // Bi·∫øn l∆∞u danh s√°ch t√†i kho·∫£n t·ª´ JSON
        let validAccounts = [];

        // Load accounts t·ª´ JSON file
        async function loadAccounts() {
            try {
                // Hi·ªÉn th·ªã loading
                document.getElementById('loadingOverlay').style.display = 'block';
                
                const response = await fetch('../data/accounts.json');
                
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i file accounts.json');
                }
                
                const data = await response.json();
                validAccounts = data.accounts;
                
                console.log('ƒê√£ load th√†nh c√¥ng', validAccounts.length, 't√†i kho·∫£n t·ª´ JSON');
                
                // ·∫®n loading
                document.getElementById('loadingOverlay').style.display = 'none';
                
            } catch (error) {
                console.error('L·ªói khi load accounts:', error);
                document.getElementById('loadingOverlay').innerHTML = 
                    '<i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>' +
                    '<p style="color: #dc3545;">L·ªói: ' + error.message + '</p>' +
                    '<p style="font-size: 12px;">Vui l√≤ng ki·ªÉm tra ƒë∆∞·ªùng d·∫´n file JSON</p>';
                
                // Fallback: S·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u n·∫øu kh√¥ng load ƒë∆∞·ª£c JSON
                validAccounts = [
                    { 
                        id: 1, 
                        username: 'admin', 
                        password: 'admin123',
                        fullName: 'Qu·∫£n Tr·ªã Vi√™n',
                        role: 'admin'
                    },
                    { 
                        id: 2, 
                        username: 'yennhi', 
                        password: 'nhi2024',
                        fullName: 'Nguy·ªÖn Th·ªã Y·∫øn Nhi',
                        role: 'user'
                    }
                ];
            }
        }

        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p khi t·∫£i trang
        window.onload = async function() {
            // Load accounts t·ª´ JSON tr∆∞·ªõc
            await loadAccounts();
            
            // Sau ƒë√≥ ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            checkLoginStatus();
            updateMenuLink();
        };

        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userData = localStorage.getItem('userData');

            if (isLoggedIn === 'true' && userData) {
                try {
                    const user = JSON.parse(userData);
                    showLogoutSection(user);
                } catch (error) {
                    console.error('L·ªói parse userData:', error);
                    showLoginForm();
                }
            } else {
                showLoginForm();
            }
        }

        // X·ª≠ l√Ω ƒëƒÉng nh·∫≠p
        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            // Ki·ªÉm tra n·∫øu ch∆∞a load xong accounts
            if (validAccounts.length === 0) {
                showError('Vui l√≤ng ƒë·ª£i h·ªá th·ªëng t·∫£i d·ªØ li·ªáu t√†i kho·∫£n!');
                return;
            }

            // Validate t√†i kho·∫£n
            const validAccount = validAccounts.find(
                account => account.username === username && account.password === password
            );

            if (validAccount) {
                // T·∫°o object user data
                const userData = {
                    id: validAccount.id,
                    username: validAccount.username,
                    fullName: validAccount.fullName,
                    role: validAccount.role,
                    loginTime: new Date().toLocaleString('vi-VN')
                };

                // L∆∞u th√¥ng tin v√†o localStorage
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('userData', JSON.stringify(userData));

                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                showSuccess('ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Ch√†o m·ª´ng ' + userData.fullName);

                // Chuy·ªÉn sang giao di·ªán ƒëƒÉng xu·∫•t sau 1 gi√¢y
                setTimeout(() => {
                    showLogoutSection(userData);
                    updateMenuLink();
                }, 1000);
            } else {
                showError('T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
            }
        }

        // X·ª≠ l√Ω ƒëƒÉng xu·∫•t
        function handleLogout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                // X√≥a th√¥ng tin kh·ªèi localStorage
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userData');

                // Hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p
                showLoginForm();
                showSuccess('ƒêƒÉng xu·∫•t th√†nh c√¥ng!');
                updateMenuLink();

                // X√≥a th√¥ng b√°o sau 2 gi√¢y
                setTimeout(() => {
                    hideMessages();
                }, 2000);
            }
        }

        // Hi·ªÉn th·ªã form ƒëƒÉng nh·∫≠p
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('logoutSection').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Hi·ªÉn th·ªã section ƒëƒÉng xu·∫•t
        function showLogoutSection(userData) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('logoutSection').style.display = 'block';
            document.getElementById('displayFullName').textContent = userData.fullName;
            document.getElementById('displayUsername').textContent = userData.username;
            document.getElementById('displayRole').textContent = 
                userData.role === 'admin' ? 'üëë Qu·∫£n tr·ªã vi√™n' : 'üë§ Ng∆∞·ªùi d√πng';
            document.getElementById('loginTime').textContent = userData.loginTime;
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';

            // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            successText.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';

            // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // ·∫®n t·∫•t c·∫£ th√¥ng b√°o
        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        // C·∫≠p nh·∫≠t link menu
        function updateMenuLink() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userData = localStorage.getItem('userData');
            const menuLink = document.getElementById('loginMenuLink');

            if (isLoggedIn === 'true' && userData) {
                try {
                    const user = JSON.parse(userData);
                    menuLink.innerHTML = '<i class="fas fa-user"></i> ' + user.username + ' (Logout)';
                } catch (error) {
                    menuLink.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login/Logout';
                }
            } else {
                menuLink.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login/Logout';
            }
        }
    </script>
</body>
</html>